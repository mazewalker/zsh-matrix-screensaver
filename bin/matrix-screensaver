#!/bin/zsh

# Matrix Digital Rain Screensaver
# Handles terminal resize, cleanup, and smooth animation

# Cleanup function
cleanup() {
    tput cnorm   # Show cursor
    tput rmcup   # Restore screen
    tput sgr0    # Reset colors
    clear
    exit 0
}

# Set up trap for clean exit
trap cleanup INT TERM

# Save current screen and hide cursor
tput smcup
tput civis

# Get terminal size
TERM_WIDTH=$(tput cols)
TERM_HEIGHT=$(tput rows)

# Initialize streams array
declare -A streams
declare -A speeds
declare -A positions

# Matrix characters (expanded set)
CHARS=(ｱ ｲ ｳ ｴ ｵ ｶ ｷ ｸ ｹ ｺ ｻ ｼ ｽ ｾ ｿ ﾀ ﾁ ﾂ ﾃ ﾄ ﾅ ﾆ ﾇ ﾈ ﾉ ﾊ ﾋ ﾌ ﾍ ﾎ ﾏ ﾐ ﾑ ﾒ ﾓ ﾔ ﾕ ﾖ ﾗ ﾘ ﾙ ﾚ ﾛ ﾜ ﾝ 0 1 2 3 4 5 6 7 8 9 @ # $ % & * + - = ? !)

# Initialize matrix streams
init_streams() {
    local i
    for ((i=0; i<TERM_WIDTH; i++)); do
        # Initialize all columns, with random starting positions
        streams[$i]=""
        speeds[$i]=$((RANDOM % 3 + 1))
        positions[$i]=$((RANDOM % TERM_HEIGHT * -1)) # Random starting positions above screen
    done
}

# Update stream positions and characters
update_streams() {
    local i char
    for i in "${(k)streams}"; do
        # Update position
        ((positions[$i]+=speeds[$i]))
        
        # Reset stream if it reaches bottom
        if ((positions[$i] >= TERM_HEIGHT)); then
            if ((RANDOM % 10 == 0)); then  # 10% chance to restart
                positions[$i]=$((RANDOM % TERM_HEIGHT * -1))
                speeds[$i]=$((RANDOM % 3 + 1))
                streams[$i]=""
            else
                positions[$i]=0
            fi
        fi
        
        # Add new character to stream
        char=${CHARS[$RANDOM % ${#CHARS[@]}]}
        streams[$i]+="$char"
        
        # Trim stream if too long
        if ((${#streams[$i]} > TERM_HEIGHT)); then
            streams[$i]=${streams[$i]:1}
        fi
    done
}

# Draw matrix effect
draw_matrix() {
    local i j char
    clear
    
    for i in "${(k)streams}"; do
        local stream=${streams[$i]}
        local pos=${positions[$i]}
        local len=${#stream}
        
        # Draw each character in the stream with different intensities
        for ((j=0; j<len; j++)); do
            local y=$((pos-j))
            if ((y >= 0 && y < TERM_HEIGHT)); then
                char=${stream:j:1}
                
                # First character (bright white)
                if ((j == 0)); then
                    tput cup $y $i
                    echo -en "\033[1;37m$char"
                # Next few characters (bright green)
                elif ((j < 3)); then
                    tput cup $y $i
                    echo -en "\033[1;32m$char"
                # Rest of characters (dark green, fading)
                else
                    local fade=$((j * 2))
                    if ((fade > 7)); then fade=7; fi
                    tput cup $y $i
                    echo -en "\033[0;32m$char"
                fi
            fi
        done
    done
}

# Main loop
init_streams

while true; do
    # Exit screensaver if any key is pressed
    if read -t 0 -n 1 key; then
        cleanup
    fi

    # Check if terminal size changed
    local new_width=$(tput cols)
    local new_height=$(tput rows)
    
    if ((new_width != TERM_WIDTH || new_height != TERM_HEIGHT)); then
        TERM_WIDTH=$new_width
        TERM_HEIGHT=$new_height
        init_streams
    fi
    
    update_streams
    draw_matrix
    
    # Control animation speed
    sleep 0.1
done